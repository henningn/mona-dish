!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var s in n)("object"==typeof exports?exports:e)[s]=n[s]}}(window,(function(){return function(){"use strict";var e={};return{493:function(e,t){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0}),t.Broker=t.BroadcastChannelBroker=t.Message=void 0;var i=function(e,t){void 0===e&&(e={}),void 0===t&&(t="*"),this.message=e,this.targetOrigin=t,this.creationDate=(new Date).getMilliseconds(),this.identifier=(new Date).getMilliseconds()+"_"+Math.random()+"_"+Math.random()};t.Message=i;var r=function(e,t){this.detail=t,this.bubbles=!0,this.cancelable=!0,this.composed=!0,this.channel=e},o=function(){function e(){this.messageListeners={},this.processedMessages={},this.cleanupCnt=0,this.TIMEOUT_IN_MS=1e3,this.MSG_EVENT="message"}return e.prototype.registerListener=function(e,t){var n=this;this.reserveListenerNS(e),this.messageListeners[e].push((function(e){e.identifier in n.processedMessages||t(e)}))},e.prototype.reserveListenerNS=function(e){this.messageListeners[e]||(this.messageListeners[e]=[]),this.messageListeners["*"]||(this.messageListeners["*"]=[])},e.prototype.unregisterListener=function(e,t){this.messageListeners[e]=(this.messageListeners[e]||[]).filter((function(e){return e!==t}))},e.prototype.answer=function(t,n,s){"string"==typeof n&&(n=new i(n)),e.isAnswer(n)||(s.identifier=e.getAnswerId(n),this.broadcast(t,s))},e.getAnswerId=function(e){return"_r_"+e.identifier},e.isAnswer=function(e){return 0==e.identifier.indexOf("_r_")},e.prototype.request=function(e,t){var n=this;"string"==typeof t&&(t=new i(t));var s=t.identifier,r=new Promise((function(t,i){var r=null,o=function(i){i.identifier!=s&&i.identifier=="_r_"+s&&(clearTimeout(r),n.unregisterListener(e,o),t(i))};r=setTimeout((function(){n.unregisterListener(e,o),i("request message performed, timeout, no return value")}),3e3),n.registerListener(e,o)}));return this.broadcast(e,t),r},e.prototype.gcProcessedMessages=function(){var e=this;if(++this.cleanupCnt%10==0){var t={};Object.keys(this.processedMessages).forEach((function(n){e.messageStillActive(n)||(t[n]=e.processedMessages[n])})),this.processedMessages=t}},e.prototype.messageStillActive=function(e){return this.processedMessages[e]>(new Date).getMilliseconds()-this.TIMEOUT_IN_MS},e.prototype.markMessageAsProcessed=function(e){this.processedMessages[e.identifier]=e.creationDate},e.EVENT_TYPE="brokerEvent",e}(),a=function(e){function t(t,n){void 0===t&&(t=function(e){if(null===window||void 0===window?void 0:window.BroadcastChannel)return new window.BroadcastChannel(e);throw Error("No Broadcast channel in the system, use a shim or provide a factory functionin the constructor")}),void 0===n&&(n="brokr");var s=e.call(this)||this;return s.brokerFactory=t,s.channelGroup=n,s.openChannels={},s.msgListener=function(e){var t,n,i=e.detail,r=e.channel;return(null===(t=s.messageListeners)||void 0===t?void 0:t[r])&&(null===(n=s.messageListeners)||void 0===n||n[r].forEach((function(e){e(i)}))),s.markMessageAsProcessed(i),!0},s.register(),s}return s(t,e),t.prototype.broadcast=function(e,t,n){void 0===n&&(n=!0);try{"string"==typeof t&&(t=new i(t));var s=JSON.stringify(t);t=JSON.parse(s);var o=new r(e,t);this.openChannels[this.channelGroup].postMessage(o),n&&this.msgListener(o)}finally{this.gcProcessedMessages()}},t.prototype.registerListener=function(t,n){e.prototype.registerListener.call(this,t,n)},t.prototype.register=function(){this.openChannels[this.channelGroup]||(this.openChannels[this.channelGroup]=this.brokerFactory(this.channelGroup)),this.openChannels[this.channelGroup].addEventListener("message",this.msgListener)},t.prototype.unregister=function(){this.openChannels[this.channelGroup].close()},t}(o);t.BroadcastChannelBroker=a;var c=function(e){function t(t,n){void 0===t&&(t=window),void 0===n&&(n="brokr");var s=e.call(this)||this;s.name=n;return s.msgHandler=function(e){return function(e){var t,n,i,r,o,a,c,u,l=null!==(n=null===(t=e)||void 0===t?void 0:t.detail)&&void 0!==n?n:null===(r=null===(i=e)||void 0===i?void 0:i.data)||void 0===r?void 0:r.detail,d=null!==(c=null===(a=null===(o=e)||void 0===o?void 0:o.data)||void 0===a?void 0:a.channel)&&void 0!==c?c:null===(u=e)||void 0===u?void 0:u.channel;if((null==l?void 0:l.identifier)&&(null==l?void 0:l.message)){var h=l;if(h.identifier in s.processedMessages)return;s.broadcast(d,h)}}(e)},s.register(t),s}return s(t,e),t.prototype.register=function(e){(this.rootElem=e.host?e.host:e,e.host)?e.host.setAttribute("data-broker","1"):(null==e?void 0:e.setAttribute)&&e.setAttribute("data-broker","1");this.rootElem.addEventListener(t.EVENT_TYPE,this.msgHandler,{capture:!0}),this.rootElem.addEventListener(this.MSG_EVENT,this.msgHandler,{capture:!0})},t.prototype.unregister=function(){this.rootElem.removeEventListener(t.EVENT_TYPE,this.msgHandler),this.rootElem.removeEventListener(this.MSG_EVENT,this.msgHandler)},t.prototype.broadcast=function(e,t){"string"==typeof t&&(t=new i(t));try{this.dispatchUp(e,t,!1,!0),this.dispatchDown(e,t,!0,!1)}finally{this.gcProcessedMessages()}},t.prototype.dispatchUp=function(e,n,s,i){if(void 0===s&&(s=!0),void 0===i&&(i=!0),s||this.msgCallListeners(e,n),this.markMessageAsProcessed(n),null!=window.parent){var o=new r(e,n);window.parent.postMessage(JSON.parse(JSON.stringify(o)),n.targetOrigin)}i&&t.dispatchSameLevel(e,n)},t.dispatchSameLevel=function(e,n){var s=t.transformToEvent(e,n,!0);window.dispatchEvent(s)},t.prototype.dispatchDown=function(e,n,s,i){void 0===s&&(s=!0),void 0===i&&(i=!0),s||this.msgCallListeners(e,n),this.processedMessages[n.identifier]=n.creationDate;var o=t.transformToEvent(e,n);Array.prototype.slice.call(document.querySelectorAll("iframe")).forEach((function(t){var s=new r(e,n);t.contentWindow.postMessage(JSON.parse(JSON.stringify(s)),n.targetOrigin)})),Array.prototype.slice.call(document.querySelectorAll("[data-broker='1']")).forEach((function(e){return e.dispatchEvent(o)})),i&&t.dispatchSameLevel(e,n)},t.prototype.msgCallListeners=function(e,t){var n=this.messageListeners[e];if(null==n?void 0:n.length){n.forEach((function(e){e(t)}))}},t.transformToEvent=function(e,n,s){void 0===s&&(s=!1);var i=new r(e,n);return i.bubbles=s,t.createCustomEvent(t.EVENT_TYPE,i)},t.createCustomEvent=function(e,t){if("function"!=typeof window.CustomEvent){var n=document.createEvent("HTMLEvents");return n.detail=t.detail,n.channel=t.channel,n.initEvent(e,t.bubbles,t.cancelable),n}var s=new window.CustomEvent(e,t);return s.channel=t.channel,s},t}(o);t.Broker=c}}[493](0,e),e}()}));
//# sourceMappingURL=Messaging.js.map