require(["rxjs"],(function(e){return function(){"use strict";var t={493:function(e,t,n){var s,r=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.BrokerFactory=t.Broker=t.BroadcastChannelBrokerFactory=t.BroadcastChannelBroker=t.Message=t.NoCrypto=void 0;var i=n(435),o=function(){function e(){}return e.prototype.decode=function(e){return e},e.prototype.encode=function(e){return e},e}();t.NoCrypto=o;var a=new o,c=function(e,t){void 0===e&&(e={}),void 0===t&&(t="*"),this.message=e,this.encoded=!1,this.targetOrigin=t,this.creationDate=(new Date).getMilliseconds(),this.identifier=(new Date).getMilliseconds()+"_"+Math.random()+"_"+Math.random()};t.Message=c;var u=function(e,t){this.detail=t,this.bubbles=!0,this.cancelable=!0,this.composed=!0,this.channel=e},d=function(){function e(){this.messageListeners={},this.subjects={},this.processedMessages={},this.cleanupCnt=0,this.TIMEOUT_IN_MS=1e3,this.MSG_EVENT="message",this.crypto=a}return e.prototype.registerListener=function(e,t){var n=this;this.reserveListenerNS(e),this.messageListeners[e].push((function(e){var s;e.identifier in n.processedMessages||(((null==e?void 0:e.encoded)||(null===(s=null==e?void 0:e.detail)||void 0===s?void 0:s.encoded))&&((null==e?void 0:e.detail)?(e.detail.message=n.crypto.decode(e.detail.message),e.detail.encoded=!1):(e.message=n.crypto.decode(e.message),e.encoded=!1)),t(e))}))},e.prototype.asSubject=function(e){var t=this;this.reserveSubjectNS(e);var n=this.subjects[e],s=n.next;return n.next=function(r){var i,o;(null===(i=r)||void 0===i?void 0:i.detail)?s.call(n,null===(o=r)||void 0===o?void 0:o.detail):t.broadcast(e,r)},n},e.prototype.asObservable=function(e){return this.asSubject(e).asObservable()},e.prototype.reserveListenerNS=function(e){this.messageListeners[e]||(this.messageListeners[e]=[]),this.messageListeners["*"]||(this.messageListeners["*"]=[])},e.prototype.reserveSubjectNS=function(e){this.subjects[e]||(this.subjects[e]=new i.Subject),this.subjects["*"]||(this.subjects["*"]=new i.Subject)},e.prototype.unregisterListener=function(e,t){this.messageListeners[e]=(this.messageListeners[e]||[]).filter((function(e){return e!==t}))},e.prototype.answer=function(t,n,s){"string"==typeof n&&(n=new c(n)),e.isAnswer(n)||(s.identifier=e.getAnswerId(n),this.broadcast(t,s))},e.getAnswerId=function(e){return"_r_"+e.identifier},e.isAnswer=function(e){return 0==e.identifier.indexOf("_r_")},e.prototype.request=function(e,t){var n=this;"string"==typeof t&&(t=new c(t));var s=t.identifier,r=new Promise((function(t,r){var i=null,o=function(r){r.identifier!=s&&r.identifier=="_r_"+s&&(clearTimeout(i),n.unregisterListener(e,o),t(r))};i=setTimeout((function(){n.unregisterListener(e,o),r("request message performed, timeout, no return value")}),3e3),n.registerListener(e,o)}));return this.broadcast(e,t),r},e.prototype.gcProcessedMessages=function(){var e=this;if(++this.cleanupCnt%10==0){var t={};Object.keys(this.processedMessages).forEach((function(n){e.messageStillActive(n)||(t[n]=e.processedMessages[n])})),this.processedMessages=t}},e.prototype.messageStillActive=function(e){return this.processedMessages[e]>(new Date).getMilliseconds()-this.TIMEOUT_IN_MS},e.prototype.markMessageAsProcessed=function(e){this.processedMessages[e.identifier]=e.creationDate},e.EVENT_TYPE="brokerEvent",e}(),l=function(e){if(null===window||void 0===window?void 0:window.BroadcastChannel)return new window.BroadcastChannel(e);throw Error("No Broadcast channel in the system, use a shim or provide a factory functionin the constructor")},h="brokr",p=function(e){function t(t,n,s){void 0===t&&(t=l),void 0===n&&(n=h),void 0===s&&(s=a);var r=e.call(this)||this;return r.brokerFactory=t,r.channelGroup=n,r.crypto=s,r.openChannels={},r.msgListener=function(e){var t,n;e.detail.encoded&&(e.detail.message=r.crypto.decode(e.detail.message),e.detail.encoded=!1);var s=e.detail,i=e.channel;return(null===(t=r.messageListeners)||void 0===t?void 0:t[i])&&(null===(n=r.messageListeners)||void 0===n||n[i].forEach((function(e){e(s)}))),r.markMessageAsProcessed(s),!0},r.crypto=s,r.register(),r}return r(t,e),t.prototype.broadcast=function(e,t,n){void 0===n&&(n=!0);try{"string"==typeof t&&(t=new c(t));var s=JSON.stringify(t);t=JSON.parse(s);var r=new u(e,t);r.detail.message=this.crypto.encode(r.detail.message),r.detail.encoded=!0,(null==this?void 0:this.subjects[e])&&this.subjects[e].next(r),this.openChannels[this.channelGroup].postMessage(r),n&&this.msgListener(r)}finally{this.gcProcessedMessages()}},t.prototype.registerListener=function(t,n){e.prototype.registerListener.call(this,t,n)},t.prototype.register=function(){this.openChannels[this.channelGroup]||(this.openChannels[this.channelGroup]=this.brokerFactory(this.channelGroup)),this.openChannels[this.channelGroup].addEventListener("message",this.msgListener)},t.prototype.unregister=function(){this.openChannels[this.channelGroup].close()},t}(d);t.BroadcastChannelBroker=p;var f=function(){function e(){this.broadCastChannelGenerator=l,this.channelGroup=h,this.crypto=a}return e.prototype.withGeneratorFunc=function(e){return this.broadCastChannelGenerator=e,this},e.prototype.withChannelGroup=function(e){return this.channelGroup=e,this},e.prototype.withCrypto=function(e){return this.crypto=e,this},e.prototype.build=function(){return new p(this.broadCastChannelGenerator,this.channelGroup,this.crypto)},e}();t.BroadcastChannelBrokerFactory=f;var v=function(e){function t(t,n,s){void 0===t&&(t=window),void 0===n&&(n="brokr"),void 0===s&&(s=a);var r=e.call(this)||this;r.name=n;return r.msgHandler=function(e){return function(e){var t,n,s,i,o,a,c,u,d,l=null!==(n=null===(t=e)||void 0===t?void 0:t.detail)&&void 0!==n?n:null===(i=null===(s=e)||void 0===s?void 0:s.data)||void 0===i?void 0:i.detail,h=null!==(c=null===(a=null===(o=e)||void 0===o?void 0:o.data)||void 0===a?void 0:a.channel)&&void 0!==c?c:null===(u=e)||void 0===u?void 0:u.channel;if((null==l?void 0:l.identifier)&&(null==l?void 0:l.message)){var p=l;if(p.identifier in r.processedMessages)return;null===(d=e)||void 0===d||d.detail,r.broadcast(h,p)}}(e)},r.crypto=s,r.register(t),r}return r(t,e),t.prototype.register=function(e){(this.rootElem=e.host?e.host:e,e.host)?e.host.setAttribute("data-broker","1"):(null==e?void 0:e.setAttribute)&&e.setAttribute("data-broker","1");this.rootElem.addEventListener(t.EVENT_TYPE,this.msgHandler,{capture:!0}),this.rootElem.addEventListener(this.MSG_EVENT,this.msgHandler,{capture:!0})},t.prototype.unregister=function(){this.rootElem.removeEventListener(t.EVENT_TYPE,this.msgHandler),this.rootElem.removeEventListener(this.MSG_EVENT,this.msgHandler)},t.prototype.broadcast=function(e,t){if("string"==typeof t&&(t=new c(t)),null==this?void 0:this.subjects[e]){var n=new u(e,t);n.detail.encoded||(n.detail.message=this.crypto.encode(n.detail.message),n.detail.encoded=!0),this.subjects[e].next(n)}try{this.dispatchUp(e,t,!1,!0),this.dispatchDown(e,t,!0,!1)}finally{this.gcProcessedMessages()}},t.prototype.dispatchUp=function(e,n,s,r){if(void 0===s&&(s=!0),void 0===r&&(r=!0),s||this.msgCallListeners(e,n),this.markMessageAsProcessed(n),null!=window.parent){var i=new u(e,n);window.parent.postMessage(JSON.parse(JSON.stringify(i)),n.targetOrigin)}r&&t.dispatchSameLevel(e,n)},t.dispatchSameLevel=function(e,n){var s=t.transformToEvent(e,n,!0);window.dispatchEvent(s)},t.prototype.dispatchDown=function(e,n,s,r){void 0===s&&(s=!0),void 0===r&&(r=!0),s||this.msgCallListeners(e,n),this.processedMessages[n.identifier]=n.creationDate;var i=t.transformToEvent(e,n);Array.prototype.slice.call(document.querySelectorAll("iframe")).forEach((function(t){var s=new u(e,n);t.contentWindow.postMessage(JSON.parse(JSON.stringify(s)),n.targetOrigin)})),Array.prototype.slice.call(document.querySelectorAll("[data-broker='1']")).forEach((function(e){return e.dispatchEvent(i)})),r&&t.dispatchSameLevel(e,n)},t.prototype.msgCallListeners=function(e,t){var n=this.messageListeners[e];if(null==n?void 0:n.length){n.forEach((function(e){e(t)}))}},t.transformToEvent=function(e,n,s){void 0===s&&(s=!1);var r=new u(e,n);return r.bubbles=s,t.createCustomEvent(t.EVENT_TYPE,r)},t.createCustomEvent=function(e,t){if("function"!=typeof window.CustomEvent){var n=document.createEvent("HTMLEvents");return n.detail=t.detail,n.channel=t.channel,n.initEvent(e,t.bubbles,t.cancelable),n}var s=new window.CustomEvent(e,t);return s.channel=t.channel,s},t}(d);t.Broker=v;var g=function(){function e(){this.scopeElement=window,this.channelGroup=h,this.crypto=a}return e.prototype.withScopeElement=function(e){return this.scopeElement=e,this},e.prototype.withChannelGroup=function(e){return this.channelGroup=e,this},e.prototype.withCrypto=function(e){return this.crypto=e,this},e.prototype.build=function(){return new v(this.scopeElement,this.channelGroup,this.crypto)},e}();t.BrokerFactory=g},435:function(t){t.exports=e}},n={};return function e(s){var r=n[s];if(void 0!==r)return r.exports;var i=n[s]={exports:{}};return t[s].call(i.exports,i,i.exports,e),i.exports}(493)}()}));
//# sourceMappingURL=Messaging.js.map