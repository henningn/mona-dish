System.register(["RxJS"],(function(e,t){var s={};return Object.defineProperty(s,"__esModule",{value:!0}),{setters:[function(e){Object.keys(e).forEach((function(t){s[t]=e[t]}))}],execute:function(){e(function(){"use strict";var e={493:function(e,t,s){var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0}),t.Broker=t.BroadcastChannelBroker=t.Message=void 0;var i=s(998),o=function(e,t){void 0===e&&(e={}),void 0===t&&(t="*"),this.message=e,this.targetOrigin=t,this.creationDate=(new Date).getMilliseconds(),this.identifier=(new Date).getMilliseconds()+"_"+Math.random()+"_"+Math.random()};t.Message=o;var a=function(e,t){this.detail=t,this.bubbles=!0,this.cancelable=!0,this.composed=!0,this.channel=e},c=function(){function e(){this.messageListeners={},this.subjects={},this.processedMessages={},this.cleanupCnt=0,this.TIMEOUT_IN_MS=1e3,this.MSG_EVENT="message"}return e.prototype.registerListener=function(e,t){var s=this;this.reserveListenerNS(e),this.messageListeners[e].push((function(e){e.identifier in s.processedMessages||t(e)}))},e.prototype.asSubject=function(e){var t=this;this.reserveSubjectNS(e);var s=this.subjects[e],n=s.next;return s.next=function(r){var i,o;(null===(i=r)||void 0===i?void 0:i.detail)?n.call(s,null===(o=r)||void 0===o?void 0:o.detail):t.broadcast(e,r)},s},e.prototype.asObservable=function(e){return this.asSubject(e).asObservable()},e.prototype.reserveListenerNS=function(e){this.messageListeners[e]||(this.messageListeners[e]=[]),this.messageListeners["*"]||(this.messageListeners["*"]=[])},e.prototype.reserveSubjectNS=function(e){this.subjects[e]||(this.subjects[e]=new i.Subject),this.subjects["*"]||(this.subjects["*"]=new i.Subject)},e.prototype.unregisterListener=function(e,t){this.messageListeners[e]=(this.messageListeners[e]||[]).filter((function(e){return e!==t}))},e.prototype.answer=function(t,s,n){"string"==typeof s&&(s=new o(s)),e.isAnswer(s)||(n.identifier=e.getAnswerId(s),this.broadcast(t,n))},e.getAnswerId=function(e){return"_r_"+e.identifier},e.isAnswer=function(e){return 0==e.identifier.indexOf("_r_")},e.prototype.request=function(e,t){var s=this;"string"==typeof t&&(t=new o(t));var n=t.identifier,r=new Promise((function(t,r){var i=null,o=function(r){r.identifier!=n&&r.identifier=="_r_"+n&&(clearTimeout(i),s.unregisterListener(e,o),t(r))};i=setTimeout((function(){s.unregisterListener(e,o),r("request message performed, timeout, no return value")}),3e3),s.registerListener(e,o)}));return this.broadcast(e,t),r},e.prototype.gcProcessedMessages=function(){var e=this;if(++this.cleanupCnt%10==0){var t={};Object.keys(this.processedMessages).forEach((function(s){e.messageStillActive(s)||(t[s]=e.processedMessages[s])})),this.processedMessages=t}},e.prototype.messageStillActive=function(e){return this.processedMessages[e]>(new Date).getMilliseconds()-this.TIMEOUT_IN_MS},e.prototype.markMessageAsProcessed=function(e){this.processedMessages[e.identifier]=e.creationDate},e.EVENT_TYPE="brokerEvent",e}(),u=function(e){function t(t,s){void 0===t&&(t=function(e){if(null===window||void 0===window?void 0:window.BroadcastChannel)return new window.BroadcastChannel(e);throw Error("No Broadcast channel in the system, use a shim or provide a factory functionin the constructor")}),void 0===s&&(s="brokr");var n=e.call(this)||this;return n.brokerFactory=t,n.channelGroup=s,n.openChannels={},n.msgListener=function(e){var t,s,r=e.detail,i=e.channel;return(null===(t=n.messageListeners)||void 0===t?void 0:t[i])&&(null===(s=n.messageListeners)||void 0===s||s[i].forEach((function(e){e(r)}))),n.markMessageAsProcessed(r),!0},n.register(),n}return r(t,e),t.prototype.broadcast=function(e,t,s){void 0===s&&(s=!0);try{"string"==typeof t&&(t=new o(t));var n=JSON.stringify(t);t=JSON.parse(n);var r=new a(e,t);(null==this?void 0:this.subjects[e])&&this.subjects[e].next(r),this.openChannels[this.channelGroup].postMessage(r),s&&this.msgListener(r)}finally{this.gcProcessedMessages()}},t.prototype.registerListener=function(t,s){e.prototype.registerListener.call(this,t,s)},t.prototype.register=function(){this.openChannels[this.channelGroup]||(this.openChannels[this.channelGroup]=this.brokerFactory(this.channelGroup)),this.openChannels[this.channelGroup].addEventListener("message",this.msgListener)},t.prototype.unregister=function(){this.openChannels[this.channelGroup].close()},t}(c);t.BroadcastChannelBroker=u;var l=function(e){function t(t,s){void 0===t&&(t=window),void 0===s&&(s="brokr");var n=e.call(this)||this;n.name=s;return n.msgHandler=function(e){return function(e){var t,s,r,i,o,a,c,u,l=null!==(s=null===(t=e)||void 0===t?void 0:t.detail)&&void 0!==s?s:null===(i=null===(r=e)||void 0===r?void 0:r.data)||void 0===i?void 0:i.detail,d=null!==(c=null===(a=null===(o=e)||void 0===o?void 0:o.data)||void 0===a?void 0:a.channel)&&void 0!==c?c:null===(u=e)||void 0===u?void 0:u.channel;if((null==l?void 0:l.identifier)&&(null==l?void 0:l.message)){var h=l;if(h.identifier in n.processedMessages)return;n.broadcast(d,h)}}(e)},n.register(t),n}return r(t,e),t.prototype.register=function(e){(this.rootElem=e.host?e.host:e,e.host)?e.host.setAttribute("data-broker","1"):(null==e?void 0:e.setAttribute)&&e.setAttribute("data-broker","1");this.rootElem.addEventListener(t.EVENT_TYPE,this.msgHandler,{capture:!0}),this.rootElem.addEventListener(this.MSG_EVENT,this.msgHandler,{capture:!0})},t.prototype.unregister=function(){this.rootElem.removeEventListener(t.EVENT_TYPE,this.msgHandler),this.rootElem.removeEventListener(this.MSG_EVENT,this.msgHandler)},t.prototype.broadcast=function(e,t){"string"==typeof t&&(t=new o(t)),(null==this?void 0:this.subjects[e])&&this.subjects[e].next(new a(e,t));try{this.dispatchUp(e,t,!1,!0),this.dispatchDown(e,t,!0,!1)}finally{this.gcProcessedMessages()}},t.prototype.dispatchUp=function(e,s,n,r){if(void 0===n&&(n=!0),void 0===r&&(r=!0),n||this.msgCallListeners(e,s),this.markMessageAsProcessed(s),null!=window.parent){var i=new a(e,s);window.parent.postMessage(JSON.parse(JSON.stringify(i)),s.targetOrigin)}r&&t.dispatchSameLevel(e,s)},t.dispatchSameLevel=function(e,s){var n=t.transformToEvent(e,s,!0);window.dispatchEvent(n)},t.prototype.dispatchDown=function(e,s,n,r){void 0===n&&(n=!0),void 0===r&&(r=!0),n||this.msgCallListeners(e,s),this.processedMessages[s.identifier]=s.creationDate;var i=t.transformToEvent(e,s);Array.prototype.slice.call(document.querySelectorAll("iframe")).forEach((function(t){var n=new a(e,s);t.contentWindow.postMessage(JSON.parse(JSON.stringify(n)),s.targetOrigin)})),Array.prototype.slice.call(document.querySelectorAll("[data-broker='1']")).forEach((function(e){return e.dispatchEvent(i)})),r&&t.dispatchSameLevel(e,s)},t.prototype.msgCallListeners=function(e,t){var s=this.messageListeners[e];if(null==s?void 0:s.length){s.forEach((function(e){e(t)}))}},t.transformToEvent=function(e,s,n){void 0===n&&(n=!1);var r=new a(e,s);return r.bubbles=n,t.createCustomEvent(t.EVENT_TYPE,r)},t.createCustomEvent=function(e,t){if("function"!=typeof window.CustomEvent){var s=document.createEvent("HTMLEvents");return s.detail=t.detail,s.channel=t.channel,s.initEvent(e,t.bubbles,t.cancelable),s}var n=new window.CustomEvent(e,t);return n.channel=t.channel,n},t}(c);t.Broker=l},998:function(e){e.exports=s}},t={};return function s(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,s),i.exports}(493)}())}}}));
//# sourceMappingURL=Messaging.js.map