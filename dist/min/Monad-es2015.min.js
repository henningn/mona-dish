export class Monad{constructor(t){this._value=t}map(t){t||(t=(t=>t));let n=t(this.value);return new Monad(n)}flatMap(t){let n=this.map(t);for(;void 0!==n&&null!=n&&n.value instanceof Monad;)n=n.value;return n}get value(){return this._value}};export class Optional extends Monad{constructor(t){super(t)}static fromNullable(t){return new Optional(t)}isAbsent(){return void 0===this.value||null==this.value}isPresent(){return!this.isAbsent()}presentOrElse(t){return this.isPresent()?this:this.flatMap(this.getClass().fromNullable(t))}flatMap(t){var n=super.flatMap(t);return n instanceof Optional?n.flatMap():Optional.fromNullable(n.value)}getIfPresent(t){return this.isAbsent()?this.getClass().absent:this.getClass().fromNullable(this.value[t]).flatMap()}getIf(...t){let n=this;for(let s=0;s<t.length;s++){let i=this.keyVal(t[s]),e=this.arrayIndex(t[s]);if(""===i&&e>=0){if((n=this.getClass().fromNullable(n.value instanceof Array?n.value.length<e?null:n.value[e]:null)).isAbsent())return n}else if(i&&e>=0){if(n.getIfPresent(i).isAbsent())return n;if((n=n.getIfPresent(i).value instanceof Array?this.getClass().fromNullable(n.getIfPresent(i).value[e]):this.getClass().absent).isAbsent())return n}else{if((n=n.getIfPresent(i)).isAbsent())return n;e>-1&&(n=this.getClass().fromNullable(n.value[e]))}}return n}get value(){return this._value instanceof Monad?this._value.flatMap().value:this._value}get(t){return this.isAbsent()?this.getClass().fromNullable(t).flatMap():this.getClass().fromNullable(this.value).flatMap()}getClass(){return Optional}toJson(){return JSON.stringify(this.value)}arrayIndex(t){let n=t.indexOf("["),s=t.indexOf("]");return n>=0&&s>0&&n<s?parseInt(t.substring(n+1,s)):-1}keyVal(t){let n=t.indexOf("[");return n>=0?t.substring(0,n):t}};Optional.absent=Optional.fromNullable(null);class ConfigEntry{constructor(t,n,s){this.rootElem=t,this.key=n,this.arrPos=void 0!==s?s:-1}get value(){return""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]:this.rootElem[this.key]}set value(t){""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]=t:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]=t:this.rootElem[this.key]=t}}export class Config extends Optional{constructor(t){super(t)}static fromNullable(t){return new Config(t)}apply(...t){if(t.length<1)return;this.buildPath(t);let n=this.keyVal(t[t.length-1]),s=this.arrayIndex(t[t.length-1]);return new ConfigEntry(1==t.length?this.value:this.getIf.apply(this,t.slice(0,t.length-1)).value,n,s)}getIf(...t){return this.getClass().fromNullable(super.getIf.apply(this,t).value)}get(t){return this.getClass().fromNullable(super.get(t).value)}toJson(){return JSON.stringify(this.value)}getClass(){return Config}setVal(t){this._value=t}buildPath(t){let n=this,s=this.getClass().fromNullable(null),i=-1,e=function(t,n){if(t.length<n)for(var s=t.length;s<n;s++)t.push({})};for(var l=0;l<t.length;l++){let u=this.keyVal(t[l]),r=this.arrayIndex(t[l]);if(""===u&&r>=0){n.setVal(n.value instanceof Array?n.value:[]),e(n.value,r+1),i>=0&&(s.value[i]=n.value),s=n,i=r,n=this.getClass().fromNullable(n.value[r]);continue}let o=n.getIf(u);if(-1==r)o.isAbsent()?o=this.getClass().fromNullable(n.value[u]={}):n=o;else{var a=o.value instanceof Array?o.value:[];e(a,r+1),n.value[u]=a,o=this.getClass().fromNullable(a[r])}s=n,i=r,n=o}return this}};export var PromiseStatus;!function(t){t[t.PENDING=0]="PENDING",t[t.FULLFILLED=1]="FULLFILLED",t[t.REJECTED=2]="REJECTED"}(PromiseStatus||(PromiseStatus={}));export class Promise{constructor(t){this.status=PromiseStatus.PENDING,this.allFuncs=[],this.value=t,this.value(t=>this.resolve(t),t=>this.reject(t))}static all(...t){var n,s=0,i=new Promise((t,s)=>{n=t}),e=()=>{s++;t.length==s&&n()};e.__last__=!0;for(var l=0;l<t.length;l++)t[l].finally(e);return i}static race(...t){var n,s,i=new Promise((t,i)=>{n=t;s=i}),e=()=>{n&&n();n=null;s=null;return null};e.__last__=!0;var l=()=>{s&&s();s=null;n=null;return null};l.__last__=!0;for(var a=0;a<t.length;a++)t[a].then(e),t[a].catch(l);return i}static reject(t){return new Promise((n,s)=>{t instanceof Promise?t.then(t=>{s(t)}):setTimeout(()=>{s(t)},1)})}static resolve(t){return new Promise((n,s)=>{t instanceof Promise?t.then(t=>n(t)):setTimeout(()=>{n(t)},1)})}then(t,n){return this.allFuncs.push({then:t}),n&&this.allFuncs.push({catch:n}),this.spliceLastFuncs(),this}catch(t){return this.allFuncs.push({catch:t}),this.spliceLastFuncs(),this}finally(t){if(!this.__reason__)return this.allFuncs.push({finally:t}),this.spliceLastFuncs(),this;this.__reason__.finally(t)}spliceLastFuncs(){let t=[],n=[];for(var s=0;s<this.allFuncs.length;s++)for(var i in this.allFuncs[s])this.allFuncs[s][i].__last__?t.push(this.allFuncs[s]):n.push(this.allFuncs[s]);this.allFuncs=n.concat(t)}resolve(t){for(;this.allFuncs.length&&this.allFuncs[0].then;){var n=this.allFuncs.shift(),s=Optional.fromNullable(n.then(t));if(!s.isPresent())break;if(s=s.flatMap(),(t=s.value)instanceof Promise)return void this.transferIntoNewPromise(t)}this.appyFinally(),this.status=PromiseStatus.FULLFILLED}reject(t){for(;this.allFuncs.length&&!this.allFuncs[0].finally;){var n=this.allFuncs.shift();if(n.catch){var s=Optional.fromNullable(n.catch(t));if(s.isPresent()){if(s=s.flatMap(),(t=s.value)instanceof Promise)return void this.transferIntoNewPromise(t);this.status=PromiseStatus.REJECTED;break}break}}this.status=PromiseStatus.REJECTED,this.appyFinally()}transferIntoNewPromise(t){for(var n=0;n<this.allFuncs.length;n++)for(let s in this.allFuncs[n])t[s](this.allFuncs[n][s])}appyFinally(){for(;this.allFuncs.length;){var t=this.allFuncs.shift();t.finally&&t.finally()}}};export class CancellablePromise extends Promise{constructor(t,n){super(t),this.cancellator=(()=>{}),this.cancellator=n}cancel(){this.status=PromiseStatus.REJECTED,this.appyFinally(),this.allFuncs=[]}then(t,n){return super.then(t,n)}catch(t){return super.catch(t)}finally(t){return super.finally(t)}};