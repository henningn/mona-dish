export class Monad{constructor(t){this._value=t}map(t){t||(t=(t=>t));let s=t(this.value);return new Monad(s)}flatMap(t){let s=this.map(t);for(;void 0!==s&&null!=s&&s.value instanceof Monad;)s=s.value;return s}get value(){return this._value}};export class Optional extends Monad{constructor(t){super(t)}static fromNullable(t){return new Optional(t)}isAbsent(){return void 0===this.value||null==this.value}isPresent(){return!this.isAbsent()}presentOrElse(t){return this.isPresent()?this:this.flatMap(this.getClass().fromNullable(t))}flatMap(t){var s=super.flatMap(t);return s instanceof Optional?s.flatMap():Optional.fromNullable(s.value)}getIfPresent(t){return this.isAbsent()?this.getClass().absent:this.getClass().fromNullable(this.value[t]).flatMap()}getIf(...t){let s=this;for(let e=0;e<t.length;e++){let l=this.keyVal(t[e]),a=this.arrayIndex(t[e]);if(""===l&&a>=0){if((s=this.getClass().fromNullable(s.value instanceof Array?s.value.length<a?null:s.value[a]:null)).isAbsent())return s}else if(l&&a>=0){if(s.getIfPresent(l).isAbsent())return s;if((s=s.getIfPresent(l).value instanceof Array?this.getClass().fromNullable(s.getIfPresent(l).value[a]):this.getClass().absent).isAbsent())return s}else{if((s=s.getIfPresent(l)).isAbsent())return s;a>-1&&(s=this.getClass().fromNullable(s.value[a]))}}return s}get value(){return this._value instanceof Monad?this._value.flatMap().value:this._value}get(t){return this.isAbsent()?this.getClass().fromNullable(t).flatMap():this.getClass().fromNullable(this.value).flatMap()}getClass(){return Optional}toJson(){return JSON.stringify(this.value)}arrayIndex(t){let s=t.indexOf("["),e=t.indexOf("]");return s>=0&&e>0&&s<e?parseInt(t.substring(s+1,e)):-1}keyVal(t){let s=t.indexOf("[");return s>=0?t.substring(0,s):t}};Optional.absent=Optional.fromNullable(null);class ConfigEntry{constructor(t,s,e){this.rootElem=t,this.key=s,this.arrPos=void 0!==e?e:-1}get value(){return""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]:this.rootElem[this.key]}set value(t){""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]=t:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]=t:this.rootElem[this.key]=t}}export class Config extends Optional{constructor(t){super(t)}static fromNullable(t){return new Config(t)}apply(...t){if(t.length<1)return;this.buildPath(t);let s=this.keyVal(t[t.length-1]),e=this.arrayIndex(t[t.length-1]);return new ConfigEntry(1==t.length?this.value:this.getIf.apply(this,t.slice(0,t.length-1)).value,s,e)}getIf(...t){return this.getClass().fromNullable(super.getIf.apply(this,t).value)}get(t){return this.getClass().fromNullable(super.get(t).value)}toJson(){return JSON.stringify(this.value)}getClass(){return Config}setVal(t){this._value=t}buildPath(t){let s=this,e=this.getClass().fromNullable(null),l=-1,a=function(t,s){if(t.length<s)for(var e=t.length;e<s;e++)t.push({})};for(var r=0;r<t.length;r++){let n=this.keyVal(t[r]),u=this.arrayIndex(t[r]);if(""===n&&u>=0){s.setVal(s.value instanceof Array?s.value:[]),a(s.value,u+1),l>=0&&(e.value[l]=s.value),e=s,l=u,s=this.getClass().fromNullable(s.value[u]);continue}let h=s.getIf(n);if(-1==u)h.isAbsent()?h=this.getClass().fromNullable(s.value[n]={}):s=h;else{var i=h.value instanceof Array?h.value:[];a(i,u+1),s.value[n]=i,h=this.getClass().fromNullable(i[u])}e=s,l=u,s=h}return this}};export var PromiseStatus;!function(t){t[t.PENDING=0]="PENDING",t[t.FULLFILLED=1]="FULLFILLED",t[t.REJECTED=2]="REJECTED"}(PromiseStatus||(PromiseStatus={}));export class Promise{constructor(t){this.status=PromiseStatus.PENDING,this.allFuncs=[],this.value=t,this.value(t=>this.resolve(t),t=>this.reject(t))}static all(...t){var s,e=0,l=new Promise((t,e)=>{s=t}),a=()=>{e++,t.length==e&&s()};a.__last__=!0;for(var r=0;r<t.length;r++)t[r].finally(a);return l}static race(...t){var s,e,l=new Promise((t,l)=>{s=t,e=l}),a=()=>(s&&s(),s=null,e=null,null);a.__last__=!0;var r=()=>(e&&e(),e=null,s=null,null);r.__last__=!0;for(var i=0;i<t.length;i++)t[i].then(a),t[i].catch(r);return l}static reject(t){return new Promise((s,e)=>{t instanceof Promise?t.then(t=>{e(t)}):setTimeout(()=>{e(t)},1)})}static resolve(t){return new Promise((s,e)=>{t instanceof Promise?t.then(t=>s(t)):setTimeout(()=>{s(t)},1)})}then(t,s){return this.allFuncs.push({then:t}),s&&this.allFuncs.push({catch:s}),this.spliceLastFuncs(),this}catch(t){return this.allFuncs.push({catch:t}),this.spliceLastFuncs(),this}finally(t){if(!this.__reason__)return this.allFuncs.push({finally:t}),this.spliceLastFuncs(),this;this.__reason__.finally(t)}spliceLastFuncs(){let t=[],s=[];for(var e=0;e<this.allFuncs.length;e++)for(var l in this.allFuncs[e])this.allFuncs[e][l].__last__?t.push(this.allFuncs[e]):s.push(this.allFuncs[e]);this.allFuncs=s.concat(t)}resolve(t){for(;this.allFuncs.length&&this.allFuncs[0].then;){var s=this.allFuncs.shift(),e=Optional.fromNullable(s.then(t));if(!e.isPresent())break;if((t=(e=e.flatMap()).value)instanceof Promise)return void this.transferIntoNewPromise(t)}this.appyFinally(),this.status=PromiseStatus.FULLFILLED}reject(t){for(;this.allFuncs.length&&!this.allFuncs[0].finally;){var s=this.allFuncs.shift();if(s.catch){var e=Optional.fromNullable(s.catch(t));if(e.isPresent()){if((t=(e=e.flatMap()).value)instanceof Promise)return void this.transferIntoNewPromise(t);this.status=PromiseStatus.REJECTED;break}break}}this.status=PromiseStatus.REJECTED,this.appyFinally()}transferIntoNewPromise(t){for(var s=0;s<this.allFuncs.length;s++)for(let e in this.allFuncs[s])t[e](this.allFuncs[s][e])}appyFinally(){for(;this.allFuncs.length;){var t=this.allFuncs.shift();t.finally&&t.finally()}}};export class CancellablePromise extends Promise{constructor(t,s){super(t),this.cancellator=(()=>{}),this.cancellator=s}cancel(){this.status=PromiseStatus.REJECTED,this.appyFinally(),this.allFuncs=[]}then(t,s){return super.then(t,s)}catch(t){return super.catch(t)}finally(t){return super.finally(t)}};