var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd&&define(["require","exports"],t)}(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this._value=t}return t.prototype.map=function(e){return e||(e=function(t){return t}),new t(e(this.value))},t.prototype.flatMap=function(e){for(var n=this.map(e);void 0!==n&&null!=n&&n.value instanceof t;)n=n.value;return n},Object.defineProperty(t.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),t}();e.Monad=n;var r=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.fromNullable=function(t){return new e(t)},e.prototype.isAbsent=function(){return void 0===this.value||null==this.value},e.prototype.isPresent=function(){return!this.isAbsent()},e.prototype.presentOrElse=function(t){return this.isPresent()?this:this.flatMap(this.getClass().fromNullable(t))},e.prototype.flatMap=function(n){var r=t.prototype.flatMap.call(this,n);return r instanceof e?r.flatMap():e.fromNullable(r.value)},e.prototype.getIfPresent=function(t){return this.isAbsent()?this.getClass().absent:this.getClass().fromNullable(this.value[t]).flatMap()},e.prototype.getIf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=this,r=0;r<t.length;r++){var s=this.keyVal(t[r]),l=this.arrayIndex(t[r]);if(""===s&&l>=0){if((n=this.getClass().fromNullable(n.value instanceof Array?n.value.length<l?null:n.value[l]:null)).isAbsent())return n}else if(s&&l>=0){if(n.getIfPresent(s).isAbsent())return n;if((n=n.getIfPresent(s).value instanceof Array?this.getClass().fromNullable(n.getIfPresent(s).value[l]):this.getClass().absent).isAbsent())return n}else{if((n=n.getIfPresent(s)).isAbsent())return n;l>-1&&(n=this.getClass().fromNullable(n.value[l]))}}return n},Object.defineProperty(e.prototype,"value",{get:function(){return this._value instanceof n?this._value.flatMap().value:this._value},enumerable:!0,configurable:!0}),e.prototype.get=function(t){return this.isAbsent()?this.getClass().fromNullable(t).flatMap():this.getClass().fromNullable(this.value).flatMap()},e.prototype.getClass=function(){return e},e.prototype.toJson=function(){return JSON.stringify(this.value)},e.prototype.arrayIndex=function(t){var e=t.indexOf("["),n=t.indexOf("]");return e>=0&&n>0&&e<n?parseInt(t.substring(e+1,n)):-1},e.prototype.keyVal=function(t){var e=t.indexOf("[");return e>=0?t.substring(0,e):t},e}(n);r.absent=r.fromNullable(null),e.Optional=r;var s=function(){function t(t,e,n){this.rootElem=t,this.key=e,this.arrPos=void 0!==n?n:-1}return Object.defineProperty(t.prototype,"value",{get:function(){return""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]:this.rootElem[this.key]},set:function(t){""==this.key&&this.arrPos>=0?this.rootElem[this.arrPos]=t:this.key&&this.arrPos>=0?this.rootElem[this.key][this.arrPos]=t:this.rootElem[this.key]=t},enumerable:!0,configurable:!0}),t}(),l=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.fromNullable=function(t){return new e(t)},e.prototype.apply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(t.length<1)){this.buildPath(t);var n=this.keyVal(t[t.length-1]),r=this.arrayIndex(t[t.length-1]);return new s(1==t.length?this.value:this.getIf.apply(this,t.slice(0,t.length-1)).value,n,r)}},e.prototype.getIf=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return this.getClass().fromNullable(t.prototype.getIf.apply(this,e).value)},e.prototype.get=function(e){return this.getClass().fromNullable(t.prototype.get.call(this,e).value)},e.prototype.toJson=function(){return JSON.stringify(this.value)},e.prototype.getClass=function(){return e},e.prototype.setVal=function(t){this._value=t},e.prototype.buildPath=function(t){for(var e=this,n=this.getClass().fromNullable(null),r=-1,s=function(t,e){if(t.length<e)for(var n=t.length;n<e;n++)t.push({})},l=0;l<t.length;l++){var i=this.keyVal(t[l]),o=this.arrayIndex(t[l]);if(""===i&&o>=0)e.setVal(e.value instanceof Array?e.value:[]),s(e.value,o+1),r>=0&&(n.value[r]=e.value),n=e,r=o,e=this.getClass().fromNullable(e.value[o]);else{var a=e.getIf(i);if(-1==o)a.isAbsent()?a=this.getClass().fromNullable(e.value[i]={}):e=a;else{var u=a.value instanceof Array?a.value:[];s(u,o+1),e.value[i]=u,a=this.getClass().fromNullable(u[o])}n=e,r=o,e=a}}return this},e}(r);e.Config=l;var i;!function(t){t[t.PENDING=0]="PENDING",t[t.FULLFILLED=1]="FULLFILLED",t[t.REJECTED=2]="REJECTED"}(i=e.PromiseStatus||(e.PromiseStatus={}));var o=function(){function t(t){var e=this;this.status=i.PENDING,this.allFuncs=[],this.value=t,this.value(function(t){return e.resolve(t)},function(t){return e.reject(t)})}return t.all=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r,s=0,l=new t(function(t,e){r=t}),i=function(){s++,e.length==s&&r()};i.__last__=!0;for(var o=0;o<e.length;o++)e[o].finally(i);return l},t.race=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r,s,l=new t(function(t,e){r=t,s=e}),i=function(){return r&&r(),r=null,s=null,null};i.__last__=!0;var o=function(){return s&&s(),s=null,r=null,null};o.__last__=!0;for(var a=0;a<e.length;a++)e[a].then(i),e[a].catch(o);return l},t.reject=function(e){return new t(function(n,r){e instanceof t?e.then(function(t){r(t)}):setTimeout(function(){r(e)},1)})},t.resolve=function(e){return new t(function(n,r){e instanceof t?e.then(function(t){return n(t)}):setTimeout(function(){n(e)},1)})},t.prototype.then=function(t,e){return this.allFuncs.push({then:t}),e&&this.allFuncs.push({catch:e}),this.spliceLastFuncs(),this},t.prototype.catch=function(t){return this.allFuncs.push({catch:t}),this.spliceLastFuncs(),this},t.prototype.finally=function(t){if(!this.__reason__)return this.allFuncs.push({finally:t}),this.spliceLastFuncs(),this;this.__reason__.finally(t)},t.prototype.spliceLastFuncs=function(){for(var t=[],e=[],n=0;n<this.allFuncs.length;n++)for(var r in this.allFuncs[n])this.allFuncs[n][r].__last__?t.push(this.allFuncs[n]):e.push(this.allFuncs[n]);this.allFuncs=e.concat(t)},t.prototype.resolve=function(e){for(;this.allFuncs.length&&this.allFuncs[0].then;){var n=this.allFuncs.shift(),s=r.fromNullable(n.then(e));if(!s.isPresent())break;if(s=s.flatMap(),(e=s.value)instanceof t)return void this.transferIntoNewPromise(e)}this.appyFinally(),this.status=i.FULLFILLED},t.prototype.reject=function(e){for(;this.allFuncs.length&&!this.allFuncs[0].finally;){var n=this.allFuncs.shift();if(n.catch){var s=r.fromNullable(n.catch(e));if(s.isPresent()){if(s=s.flatMap(),(e=s.value)instanceof t)return void this.transferIntoNewPromise(e);this.status=i.REJECTED;break}break}}this.status=i.REJECTED,this.appyFinally()},t.prototype.transferIntoNewPromise=function(t){for(var e=0;e<this.allFuncs.length;e++)for(var n in this.allFuncs[e])t[n](this.allFuncs[e][n])},t.prototype.appyFinally=function(){for(;this.allFuncs.length;){var t=this.allFuncs.shift();t.finally&&t.finally()}},t}();e.Promise=o;var a=function(t){function e(e,n){var r=t.call(this,e)||this;return r.cancellator=function(){},r.cancellator=n,r}return __extends(e,t),e.prototype.cancel=function(){this.status=i.REJECTED,this.appyFinally(),this.allFuncs=[]},e.prototype.then=function(e,n){return t.prototype.then.call(this,e,n)},e.prototype.catch=function(e){return t.prototype.catch.call(this,e)},e.prototype.finally=function(e){return t.prototype.finally.call(this,e)},e}(o);e.CancellablePromise=a});